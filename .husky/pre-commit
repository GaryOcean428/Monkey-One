# Modern Husky v9+ format

# Exit on any error (but allow pnpm not found)
set -e

echo "üîç Running pre-commit checks..."

# Check if pnpm is available
if ! command -v pnpm &> /dev/null; then
  echo "‚ö†Ô∏è  pnpm not found in PATH, skipping pre-commit hooks"
  echo "‚ÑπÔ∏è  Install pnpm globally or run: corepack enable"
  exit 0
fi

# Run lint-staged for formatting and linting
echo "üìù Running lint-staged..."
pnpm lint-staged

# Type checking (lenient mode for development)
echo "üîç Type checking..."
pnpm run type-check || {
  echo "‚ö†Ô∏è  TypeScript errors found. Consider running 'pnpm run type-check:strict' before production."
  echo "‚ÑπÔ∏è  Continuing with commit (type errors are non-blocking in development)"
}

# Security audit (quick check) - non-blocking for development
echo "üîí Security audit..."
pnpm audit --audit-level high --production || {
  echo "‚ö†Ô∏è  Security vulnerabilities found. Run 'pnpm audit fix' to resolve."
  echo "‚ÑπÔ∏è  Continuing with commit (audit failures are non-blocking in development)"
}

# Check for secrets in staged files (basic check)
echo "üîê Checking for secrets..."
git diff --cached --name-only | xargs grep -l -E "(api_key|secret|password|token)" 2>/dev/null | grep -v ".env.example" | grep -v ".env.template" && {
  echo "‚ö†Ô∏è  Potential secrets detected in staged files!"
  echo "Please review and remove any sensitive information before committing."
  echo "‚ÑπÔ∏è  If these are test values or examples, consider adding them to .gitignore patterns"
} || true

echo "‚úÖ Pre-commit checks passed!"
